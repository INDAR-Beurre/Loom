<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loom Browser</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        forest: {
                            50: "#f0fdf4",
                            100: "#dcfce7",
                            200: "#bbf7d0",
                            300: "#86efac",
                            400: "#4ade80",
                            500: "#22c55e",
                            600: "#16a34a",
                            700: "#15803d",
                            800: "#166534",
                            900: "#14532d",
                            950: "#052e16",
                        },
                        accent: {
                            400: "#4ade80",
                            500: "#22c55e",
                            600: "#16a34a",
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(34, 197, 94, 0.3)',
                        'glass': '0 8px 32px rgba(0, 0, 0, 0.1)',
                        'glass-dark': '0 8px 32px rgba(0, 0, 0, 0.3)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(120, 120, 120, 0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(120, 120, 120, 0.4);
        }
        .dark ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Highlight for search suggestions */
        b {
            color: var(--accent-500);
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-forest-50 dark:bg-forest-950 text-forest-900 dark:text-forest-50 overflow-hidden h-screen w-full transition-colors duration-300">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext, useRef, useCallback } = React;

        // --- UTILS ---
        function cn(...inputs) {
            return inputs.filter(Boolean).join(" ");
        }

        function generateId() {
            return Math.random().toString(36).substring(2, 15);
        }

        function truncate(str, length) {
            if (str.length <= length) return str;
            return str.slice(0, length) + "...";
        }

        // JSONP Utility for CORS-free requests (DuckDuckGo)
        let jsonpCounter = 0;
        function jsonp(url, callbackParam, onSuccess) {
            const callbackName = 'jsonp_cb_' + (jsonpCounter++);
            window[callbackName] = (data) => {
                delete window[callbackName];
                document.body.removeChild(script);
                onSuccess(data);
            };

            const script = document.createElement('script');
            script.src = `${url}${url.includes('?') ? '&' : '?'}${callbackParam}=${callbackName}`;
            script.onerror = () => {
                delete window[callbackName];
                document.body.removeChild(script);
            };
            document.body.appendChild(script);
        }

        // --- CONSTANTS ---
        const GROQ_MODELS = [
            { id: "llama3-8b-8192", name: "Llama 3 (8B)" },
            { id: "llama3-70b-8192", name: "Llama 3 (70B)" },
            { id: "mixtral-8x7b-32768", name: "Mixtral 8x7B" },
            { id: "gemma-7b-it", name: "Gemma 7B" }
        ];

        const SEARCH_ENGINES = [
            { id: "duckduckgo", name: "DuckDuckGo", url: "https://duckduckgo.com/?q=" },
            { id: "google", name: "Google", url: "https://www.google.com/search?q=" },
            { id: "bing", name: "Bing", url: "https://www.bing.com/search?q=" }
        ];

        // --- ICONS ---
        const Icon = ({ name, className, ...props }) => {
            const iRef = useRef(null);
            useEffect(() => {
                if (iRef.current) {
                    lucide.createIcons({
                        root: iRef.current.parentNode,
                        nameAttr: 'data-lucide',
                        attrs: {
                            class: className,
                            ...props
                        }
                    });
                }
            }, [name, className]);
            return <i data-lucide={name} ref={iRef} className={className}></i>;
        };

        const Icons = {
            ArrowLeft: (props) => <Icon name="arrow-left" {...props} />,
            ArrowRight: (props) => <Icon name="arrow-right" {...props} />,
            RotateCw: (props) => <Icon name="rotate-cw" {...props} />,
            Home: (props) => <Icon name="home" {...props} />,
            Search: (props) => <Icon name="search" {...props} />,
            Menu: (props) => <Icon name="menu" {...props} />,
            Sparkles: (props) => <Icon name="sparkles" {...props} />,
            X: (props) => <Icon name="x" {...props} />,
            Plus: (props) => <Icon name="plus" {...props} />,
            Moon: (props) => <Icon name="moon" {...props} />,
            Sun: (props) => <Icon name="sun" {...props} />,
            Shield: (props) => <Icon name="shield" {...props} />,
            Send: (props) => <Icon name="send" {...props} />,
            Bot: (props) => <Icon name="bot" {...props} />,
            User: (props) => <Icon name="user" {...props} />,
            Loader2: (props) => <Icon name="loader-2" {...props} />,
            Trash2: (props) => <Icon name="trash-2" {...props} />,
            Globe: (props) => <Icon name="globe" {...props} />,
            ExternalLink: (props) => <Icon name="external-link" {...props} />,
            Compass: (props) => <Icon name="compass" {...props} />,
            Clock: (props) => <Icon name="clock" {...props} />,
            Bookmark: (props) => <Icon name="bookmark" {...props} />,
            AlertTriangle: (props) => <Icon name="alert-triangle" {...props} />,
            Settings: (props) => <Icon name="settings" {...props} />,
            Download: (props) => <Icon name="download" {...props} />,
            Puzzle: (props) => <Icon name="puzzle" {...props} />,
            HelpCircle: (props) => <Icon name="help-circle" {...props} />,
            MoreVertical: (props) => <Icon name="more-vertical" {...props} />,
            Check: (props) => <Icon name="check" {...props} />
        };

        // --- SETTINGS STORE ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        // --- CONTEXTS ---
        
        const SettingsContext = createContext();
        const SettingsProvider = ({ children }) => {
            const [groqKey, setGroqKey] = useStickyState("", "loom_groq_key");
            const [groqModel, setGroqModel] = useStickyState(GROQ_MODELS[0].id, "loom_groq_model");
            const [theme, setTheme] = useStickyState("dark", "loom_theme");
            const [searchEngine, setSearchEngine] = useStickyState("duckduckgo", "loom_search_engine");
            const [extensions, setExtensions] = useStickyState([
                { id: "dark-reader", name: "Dark Mode Enforcer", description: "Forces dark mode on all web views", enabled: false },
                { id: "ad-block", name: "Ad Shield", description: "Simulates blocking intrusive ads", enabled: true },
                { id: "dev-tools", name: "DevTools Lite", description: "Inspect elements (Simulation)", enabled: false }
            ], "loom_extensions");

            useEffect(() => {
                if (theme === "dark") document.documentElement.classList.add("dark");
                else document.documentElement.classList.remove("dark");
            }, [theme]);

            const toggleExtension = (id) => {
                setExtensions(prev => prev.map(ext => ext.id === id ? { ...ext, enabled: !ext.enabled } : ext));
            };

            return (
                <SettingsContext.Provider value={{ 
                    groqKey, setGroqKey, 
                    groqModel, setGroqModel, 
                    theme, setTheme,
                    searchEngine, setSearchEngine,
                    extensions, toggleExtension
                }}>
                    {children}
                </SettingsContext.Provider>
            );
        };
        const useSettings = () => useContext(SettingsContext);

        const BrowserContext = createContext();
        const BrowserProvider = ({ children }) => {
            const [bookmarks, setBookmarks] = useStickyState([], "loom_bookmarks");
            const [history, setHistory] = useStickyState([], "loom_history");

            const createHomeEntry = () => ({ id: generateId(), type: "home", title: "Loom - Home", timestamp: Date.now() });
            const createDefaultTab = () => ({
                id: generateId(),
                title: "Loom - Home",
                type: "home",
                history: [createHomeEntry()],
                historyIndex: 0
            });

            const [tabs, setTabs] = useState([createDefaultTab()]);
            const [activeTabId, setActiveTabId] = useState(tabs[0].id);
            const activeTab = tabs.find(t => t.id === activeTabId);
            
            const canGoBack = activeTab ? activeTab.historyIndex > 0 : false;
            const canGoForward = activeTab ? activeTab.historyIndex < activeTab.history.length - 1 : false;

            const updateTab = (tabId, updates) => {
                setTabs(prev => prev.map(tab => tab.id === tabId ? { ...tab, ...updates } : tab));
            };

            const createTab = () => {
                const newTab = createDefaultTab();
                setTabs(prev => [...prev, newTab]);
                setActiveTabId(newTab.id);
            };

            const closeTab = (tabId) => {
                if (tabs.length === 1) return; 
                const index = tabs.findIndex(t => t.id === tabId);
                const newTabs = tabs.filter(t => t.id !== tabId);
                setTabs(newTabs);
                if (tabId === activeTabId) {
                    setActiveTabId(newTabs[Math.min(index, newTabs.length - 1)].id);
                }
            };

            const switchTab = (id) => setActiveTabId(id);

            const addToHistory = (entry) => {
                setHistory(prev => [entry, ...prev].slice(0, 100));
            };

            const addBookmark = (title, url) => {
                setBookmarks(prev => [...prev, { id: generateId(), title, url, date: Date.now() }]);
            };

            const removeBookmark = (id) => {
                setBookmarks(prev => prev.filter(b => b.id !== id));
            };

            const navigate = (input) => {
                if (!activeTab) return;
                const isUrl = input.includes(".") && !input.includes(" ");
                let newEntry;
                
                if (isUrl) {
                    const url = input.startsWith("http") ? input : `https://${input}`;
                    const hostname = new URL(url).hostname;
                    newEntry = { id: generateId(), type: "site", url, title: hostname, timestamp: Date.now() };
                } else {
                    newEntry = { id: generateId(), type: "search", query: input, title: `${input} - Search`, timestamp: Date.now() };
                }

                const newHistory = [...activeTab.history.slice(0, activeTab.historyIndex + 1), newEntry];
                updateTab(activeTabId, {
                    ...newEntry,
                    history: newHistory,
                    historyIndex: newHistory.length - 1
                });
                
                addToHistory({
                    title: newEntry.title,
                    url: newEntry.url || `search://${newEntry.query}`,
                    date: Date.now()
                });
            };

            const goBack = () => {
                if (!canGoBack) return;
                const newIndex = activeTab.historyIndex - 1;
                const entry = activeTab.history[newIndex];
                updateTab(activeTabId, { ...entry, historyIndex: newIndex });
            };

            const goForward = () => {
                if (!canGoForward) return;
                const newIndex = activeTab.historyIndex + 1;
                const entry = activeTab.history[newIndex];
                updateTab(activeTabId, { ...entry, historyIndex: newIndex });
            };

            const reload = () => {
                if (!activeTab) return;
                // Updating timestamp triggers re-render in BrowserView
                updateTab(activeTabId, { timestamp: Date.now() }); 
            };

            const goHome = () => {
                const newEntry = createHomeEntry();
                const newHistory = [...activeTab.history.slice(0, activeTab.historyIndex + 1), newEntry];
                updateTab(activeTabId, {
                    ...newEntry,
                    history: newHistory,
                    historyIndex: newHistory.length - 1
                });
            };

            return (
                <BrowserContext.Provider value={{
                    tabs, activeTabId, activeTab, createTab, closeTab, switchTab,
                    navigate, goBack, goForward, reload, goHome, canGoBack, canGoForward,
                    bookmarks, addBookmark, removeBookmark, history
                }}>
                    {children}
                </BrowserContext.Provider>
            );
        };
        const useBrowser = () => useContext(BrowserContext);

        // AI Context
        const AIContext = createContext();
        const AIProvider = ({ children }) => {
            const { groqKey, groqModel } = useSettings();
            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            const toggleAssistant = () => setIsOpen(prev => !prev);
            const closeAssistant = () => setIsOpen(false);
            const clearMessages = () => {
                setMessages([]);
                setError(null);
            };

            const sendUserMessage = async (text) => {
                const userMsg = { id: generateId(), role: "user", content: text };
                setMessages(prev => [...prev, userMsg]);
                setIsLoading(true);
                setError(null);
                
                try {
                    if (!groqKey) {
                        // Simulation Mode
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        setMessages(prev => [...prev, { 
                            id: generateId(), 
                            role: "assistant", 
                            content: "I am running in simulation mode because no Groq API Key was provided. Please add your key in Settings > AI to unlock my full potential! \n\nFor now, I can tell you that you are browsing with Loom." 
                        }]);
                    } else {
                        // Real API Call
                        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${groqKey}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                messages: [
                                    { role: "system", content: "You are Loom, a helpful AI browser assistant. Keep answers concise." },
                                    ...messages.map(m => ({ role: m.role, content: m.content })),
                                    { role: "user", content: text }
                                ],
                                model: groqModel
                            })
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.error?.message || "API Request Failed");
                        }

                        const data = await response.json();
                        const content = data.choices[0]?.message?.content || "No response.";
                        setMessages(prev => [...prev, { id: generateId(), role: "assistant", content }]);
                    }
                } catch (e) {
                    console.error(e);
                    setError(e.message);
                    setMessages(prev => [...prev, { id: generateId(), role: "assistant", content: "Error: " + e.message }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <AIContext.Provider value={{
                    isOpen, toggleAssistant, closeAssistant, messages, isLoading, sendUserMessage, clearMessages, error
                }}>
                    {children}
                </AIContext.Provider>
            );
        };
        const useAI = () => useContext(AIContext);

        // --- COMPONENTS ---

        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                <div className="w-full max-w-2xl max-h-[80vh] overflow-hidden bg-forest-50 dark:bg-forest-900 rounded-xl shadow-2xl border border-white/10 m-4 flex flex-col" onClick={e => e.stopPropagation()}>
                    <div className="flex items-center justify-between p-4 border-b border-forest-200 dark:border-forest-800 bg-forest-100 dark:bg-forest-950/50">
                        <h2 className="text-lg font-semibold">{title}</h2>
                        <button onClick={onClose} className="p-1 rounded-full hover:bg-white/10"><Icons.X className="w-5 h-5" /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6">
                        {children}
                    </div>
                </div>
            </div>
        );

        const SettingsModal = ({ onClose }) => {
            const { 
                groqKey, setGroqKey, 
                groqModel, setGroqModel, 
                theme, setTheme, 
                extensions, toggleExtension 
            } = useSettings();
            const [activeTab, setActiveTab] = useState("general");

            return (
                <Modal title="Loom Settings" onClose={onClose}>
                    <div className="flex gap-6 h-full">
                        <div className="w-40 space-y-1 border-r border-forest-200 dark:border-forest-800 pr-4">
                            {['General', 'AI', 'Extensions', 'About'].map(tab => (
                                <button 
                                    key={tab}
                                    onClick={() => setActiveTab(tab.toLowerCase())}
                                    className={cn(
                                        "w-full text-left px-3 py-2 rounded-lg text-sm transition-colors",
                                        activeTab === tab.toLowerCase() 
                                            ? "bg-accent-500 text-white" 
                                            : "hover:bg-forest-200 dark:hover:bg-forest-800 text-forest-600 dark:text-forest-400"
                                    )}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>
                        <div className="flex-1 space-y-6">
                            {activeTab === "general" && (
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Theme</label>
                                        <div className="flex gap-2 bg-forest-200 dark:bg-forest-950 p-1 rounded-lg w-fit">
                                            <button onClick={() => setTheme("light")} className={cn("px-4 py-1.5 rounded-md text-sm flex items-center gap-2", theme === "light" ? "bg-white shadow text-forest-900" : "text-forest-500 hover:text-forest-900")}>
                                                <Icons.Sun className="w-4 h-4" /> Light
                                            </button>
                                            <button onClick={() => setTheme("dark")} className={cn("px-4 py-1.5 rounded-md text-sm flex items-center gap-2", theme === "dark" ? "bg-forest-800 shadow text-white" : "text-forest-500 hover:text-forest-50")}>
                                                <Icons.Moon className="w-4 h-4" /> Dark
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Search Engine</label>
                                        <select className="w-full bg-white dark:bg-forest-950 border border-forest-300 dark:border-forest-800 rounded-lg px-3 py-2 text-sm">
                                            <option value="ddg">DuckDuckGo</option>
                                            <option value="google">Google</option>
                                            <option value="bing">Bing</option>
                                        </select>
                                    </div>
                                </div>
                            )}
                            {activeTab === "ai" && (
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Groq API Key</label>
                                        <input 
                                            type="password" 
                                            value={groqKey} 
                                            onChange={(e) => setGroqKey(e.target.value)}
                                            placeholder="gsk_..."
                                            className="w-full bg-white dark:bg-forest-950 border border-forest-300 dark:border-forest-800 rounded-lg px-3 py-2 text-sm font-mono"
                                        />
                                        <p className="text-xs text-forest-500 mt-1">Your key is stored locally in your browser.</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">AI Model</label>
                                        <select 
                                            value={groqModel} 
                                            onChange={(e) => setGroqModel(e.target.value)}
                                            className="w-full bg-white dark:bg-forest-950 border border-forest-300 dark:border-forest-800 rounded-lg px-3 py-2 text-sm"
                                        >
                                            {GROQ_MODELS.map(model => (
                                                <option key={model.id} value={model.id}>{model.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                            )}
                            {activeTab === "extensions" && (
                                <div className="space-y-4">
                                    <div className="p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg text-xs text-amber-800 dark:text-amber-200">
                                        <strong className="block mb-1">Note regarding Chrome Extensions:</strong>
                                        Due to browser security sandboxing (XSS/CORS), standard Chrome extensions cannot run inside a website. Loom uses "Simulated Extensions" to enhance functionality safely.
                                    </div>
                                    <div className="space-y-2">
                                        {extensions.map(ext => (
                                            <div key={ext.id} className="flex items-center justify-between p-3 bg-white dark:bg-forest-950 rounded-lg border border-forest-200 dark:border-forest-800">
                                                <div>
                                                    <div className="font-medium text-sm">{ext.name}</div>
                                                    <div className="text-xs text-forest-500">{ext.description}</div>
                                                </div>
                                                <button 
                                                    onClick={() => toggleExtension(ext.id)}
                                                    className={cn(
                                                        "relative inline-flex h-6 w-11 items-center rounded-full transition-colors",
                                                        ext.enabled ? "bg-accent-500" : "bg-gray-300 dark:bg-gray-700"
                                                    )}
                                                >
                                                    <span className={cn("inline-block h-4 w-4 transform rounded-full bg-white transition-transform ml-1", ext.enabled ? "translate-x-5" : "translate-x-0")} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {activeTab === "about" && (
                                <div className="text-center pt-4">
                                    <div className="w-16 h-16 bg-gradient-to-br from-forest-500 to-forest-700 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-glow">
                                        <Icons.Compass className="w-8 h-8 text-white" />
                                    </div>
                                    <h3 className="text-xl font-bold">Loom Browser</h3>
                                    <p className="text-forest-500 text-sm mt-1">Version 0.1.0 (Beta)</p>
                                    <p className="text-forest-500 text-sm mt-4 max-w-xs mx-auto">
                                        A privacy-first AI browser interface built with React and Tailwind.
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                </Modal>
            );
        };

        const HistoryModal = ({ onClose }) => {
            const { history } = useBrowser();
            return (
                <Modal title="History" onClose={onClose}>
                    {history.length === 0 ? (
                        <div className="text-center text-forest-500 py-8">No history yet.</div>
                    ) : (
                        <div className="space-y-2">
                            {history.map((item, i) => (
                                <div key={i} className="flex items-center justify-between p-2 hover:bg-forest-100 dark:hover:bg-forest-800 rounded-lg group">
                                    <div className="min-w-0">
                                        <div className="text-sm font-medium truncate">{item.title}</div>
                                        <div className="text-xs text-forest-500 truncate">{item.url}</div>
                                    </div>
                                    <div className="text-xs text-forest-400">
                                        {new Date(item.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </Modal>
            );
        };

        const BookmarksModal = ({ onClose }) => {
            const { bookmarks, removeBookmark, navigate } = useBrowser();
            return (
                <Modal title="Bookmarks" onClose={onClose}>
                    {bookmarks.length === 0 ? (
                        <div className="text-center text-forest-500 py-8">No bookmarks yet.</div>
                    ) : (
                        <div className="space-y-2">
                            {bookmarks.map((item) => (
                                <div key={item.id} className="flex items-center justify-between p-2 hover:bg-forest-100 dark:hover:bg-forest-800 rounded-lg group">
                                    <div className="flex items-center gap-3 min-w-0 cursor-pointer" onClick={() => { navigate(item.url); onClose(); }}>
                                        <div className="w-8 h-8 bg-forest-200 dark:bg-forest-700 rounded flex items-center justify-center shrink-0 text-sm">
                                            {item.title[0]}
                                        </div>
                                        <div className="min-w-0">
                                            <div className="text-sm font-medium truncate">{item.title}</div>
                                            <div className="text-xs text-forest-500 truncate">{item.url}</div>
                                        </div>
                                    </div>
                                    <button onClick={() => removeBookmark(item.id)} className="p-1.5 text-forest-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <Icons.Trash2 className="w-4 h-4" />
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                </Modal>
            );
        };

        // Browser Chrome
        const BrowserChrome = () => {
            const { 
                activeTab, navigate, goBack, goForward, reload, goHome, 
                canGoBack, canGoForward, tabs, activeTabId, switchTab, createTab, closeTab,
                addBookmark
            } = useBrowser();
            const { toggleAssistant, isOpen: isAIOpen } = useAI();
            const { theme } = useSettings();
            const [input, setInput] = useState("");
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [showBookmarks, setShowBookmarks] = useState(false);
            const menuRef = useRef(null);

            useEffect(() => {
                if (activeTab) {
                    if (activeTab.type === "search") setInput(activeTab.query || "");
                    else if (activeTab.type === "site") setInput(activeTab.url || "");
                    else setInput("");
                }
            }, [activeTab]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsMenuOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const handleSubmit = (e) => {
                e.preventDefault();
                navigate(input);
            };

            const handleBookmark = () => {
                if (activeTab && activeTab.url) {
                    addBookmark(activeTab.title, activeTab.url);
                    // Simple feedback animation could go here
                }
            };

            return (
                <div className="flex flex-col w-full bg-forest-900/90 backdrop-blur-md text-white border-b border-white/10 z-50">
                    {showSettings && <SettingsModal onClose={() => setShowSettings(false)} />}
                    {showHistory && <HistoryModal onClose={() => setShowHistory(false)} />}
                    {showBookmarks && <BookmarksModal onClose={() => setShowBookmarks(false)} />}

                    {/* Tabs */}
                    <div className="flex items-end px-2 pt-2 space-x-1 overflow-x-auto h-10 w-full no-scrollbar">
                        {tabs.map(tab => (
                            <div key={tab.id} 
                                onClick={() => switchTab(tab.id)}
                                className={cn(
                                    "group relative flex items-center max-w-[200px] min-w-[120px] h-8 px-3 rounded-t-lg cursor-pointer transition-all select-none",
                                    tab.id === activeTabId ? "bg-forest-800 text-white" : "bg-forest-950/50 text-gray-400 hover:bg-forest-900/50"
                                )}
                            >
                                <span className="truncate flex-1 text-xs">{tab.title}</span>
                                <button onClick={(e) => { e.stopPropagation(); closeTab(tab.id); }} 
                                    className="ml-2 p-0.5 rounded-full opacity-0 group-hover:opacity-100 hover:bg-white/20">
                                    <Icons.X className="w-3 h-3" />
                                </button>
                            </div>
                        ))}
                        <button onClick={createTab} className="p-1.5 rounded-full hover:bg-white/10 text-gray-400 mb-1">
                            <Icons.Plus className="w-4 h-4" />
                        </button>
                    </div>

                    {/* Nav Bar */}
                    <div className="flex items-center px-4 py-2 gap-3 h-14 bg-forest-900 shadow-lg z-20">
                        <div className="flex items-center gap-1 text-gray-300">
                            <button onClick={goBack} disabled={!canGoBack} title="Back" className="p-2 rounded-full hover:bg-white/10 disabled:opacity-30 transition-colors">
                                <Icons.ArrowLeft className="w-4 h-4" />
                            </button>
                            <button onClick={goForward} disabled={!canGoForward} title="Forward" className="p-2 rounded-full hover:bg-white/10 disabled:opacity-30 transition-colors">
                                <Icons.ArrowRight className="w-4 h-4" />
                            </button>
                            <button onClick={reload} title="Reload" className="p-2 rounded-full hover:bg-white/10 transition-colors">
                                <Icons.RotateCw className="w-4 h-4" />
                            </button>
                            <button onClick={goHome} title="Home" className="p-2 rounded-full hover:bg-white/10 transition-colors">
                                <Icons.Home className="w-4 h-4" />
                            </button>
                        </div>

                        {/* Address Bar */}
                        <div className="flex-1 relative group">
                            <div className="absolute inset-0 bg-forest-950/50 rounded-full group-focus-within:ring-2 group-focus-within:ring-accent-500/50 transition-all"></div>
                            <form onSubmit={handleSubmit} className="relative flex items-center w-full h-9 px-3 z-10">
                                <div className="mr-2 text-gray-400">
                                    {activeTab?.type === "search" ? <Icons.Search className="w-4 h-4" /> : <Icons.Shield className="w-4 h-4 text-accent-500" />}
                                </div>
                                <input 
                                    type="text" 
                                    value={input} 
                                    onChange={(e) => setInput(e.target.value)}
                                    placeholder="Search DuckDuckGo or enter URL"
                                    className="w-full bg-transparent border-none outline-none text-white placeholder:text-gray-500 text-sm h-full"
                                />
                                {activeTab?.type === "site" && (
                                    <button type="button" onClick={handleBookmark} className="p-1 rounded hover:bg-white/10 text-gray-400 hover:text-accent-400">
                                        <Icons.Bookmark className="w-4 h-4" />
                                    </button>
                                )}
                            </form>
                        </div>

                        {/* Actions */}
                        <div className="flex items-center gap-2 text-gray-300">
                            <button onClick={toggleAssistant} className={cn("p-2 rounded-full hover:bg-white/10 relative transition-colors", isAIOpen && "text-accent-400 bg-accent-500/10")}>
                                <Icons.Sparkles className="w-4 h-4" />
                            </button>
                            
                            <div className="relative" ref={menuRef}>
                                <button onClick={() => setIsMenuOpen(!isMenuOpen)} className={cn("p-2 rounded-full hover:bg-white/10 transition-colors", isMenuOpen && "bg-white/10")}>
                                    <Icons.Menu className="w-4 h-4" />
                                </button>

                                {/* Burger Menu */}
                                {isMenuOpen && (
                                    <div className="absolute top-full right-0 mt-2 w-56 bg-forest-900 border border-white/10 rounded-xl shadow-xl py-1 text-sm text-gray-200 overflow-hidden animate-slide-down origin-top-right z-50">
                                        <button onClick={() => { createTab(); setIsMenuOpen(false); }} className="w-full px-4 py-2.5 hover:bg-white/10 flex items-center gap-3 text-left">
                                            <Icons.Plus className="w-4 h-4" /> New Tab
                                        </button>
                                        <div className="h-px bg-white/10 my-1"></div>
                                        <button onClick={() => { setShowHistory(true); setIsMenuOpen(false); }} className="w-full px-4 py-2.5 hover:bg-white/10 flex items-center gap-3 text-left">
                                            <Icons.Clock className="w-4 h-4" /> History
                                        </button>
                                        <button onClick={() => { setShowBookmarks(true); setIsMenuOpen(false); }} className="w-full px-4 py-2.5 hover:bg-white/10 flex items-center gap-3 text-left">
                                            <Icons.Bookmark className="w-4 h-4" /> Bookmarks
                                        </button>
                                        <button onClick={() => { setShowSettings(true); setIsMenuOpen(false); }} className="w-full px-4 py-2.5 hover:bg-white/10 flex items-center gap-3 text-left">
                                            <Icons.Download className="w-4 h-4" /> Downloads
                                        </button>
                                        <div className="h-px bg-white/10 my-1"></div>
                                        <button onClick={() => { setShowSettings(true); setIsMenuOpen(false); }} className="w-full px-4 py-2.5 hover:bg-white/10 flex items-center gap-3 text-left">
                                            <Icons.Puzzle className="w-4 h-4" /> Extensions
                                        </button>
                                        <button onClick={() => { setShowSettings(true); setIsMenuOpen(false); }} className="w-full px-4 py-2.5 hover:bg-white/10 flex items-center gap-3 text-left">
                                            <Icons.Settings className="w-4 h-4" /> Settings
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // AI Assistant Component
        const AIAssistant = () => {
            const { isOpen, closeAssistant, messages, sendUserMessage, isLoading, clearMessages, error } = useAI();
            const [input, setInput] = useState("");
            const endRef = useRef(null);
            const { groqKey } = useSettings();

            useEffect(() => {
                endRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages, isOpen]);

            const handleSend = (e) => {
                e.preventDefault();
                if (!input.trim() || isLoading) return;
                sendUserMessage(input);
                setInput("");
            };

            if (!isOpen) return null;

            return (
                <div className="fixed top-24 right-4 w-80 md:w-96 h-[calc(100vh-7rem)] flex flex-col bg-forest-950/95 backdrop-blur-xl border border-white/20 rounded-2xl shadow-glass-dark z-40 animate-fade-in">
                    <div className="flex items-center justify-between p-4 border-b border-white/10 bg-forest-900/50 rounded-t-2xl">
                        <div className="flex items-center gap-2 text-accent-400">
                            <Icons.Sparkles className="w-5 h-5" />
                            <h3 className="font-semibold text-white">Loom AI</h3>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={clearMessages} className="p-1.5 rounded hover:bg-white/10 text-gray-400 hover:text-red-400" title="Clear Chat">
                                <Icons.Trash2 className="w-4 h-4" />
                            </button>
                            <button onClick={closeAssistant} className="p-1.5 rounded hover:bg-white/10 text-gray-400 hover:text-white">
                                <Icons.X className="w-4 h-4" />
                            </button>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {!groqKey && messages.length === 0 && (
                            <div className="p-3 bg-yellow-900/30 border border-yellow-700/50 rounded-lg text-xs text-yellow-200 mb-4">
                                <Icons.AlertTriangle className="w-4 h-4 inline mr-1" />
                                No API Key configured. AI is running in simulation mode. Add a key in Settings to use real Groq models.
                            </div>
                        )}
                        {messages.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-full text-center p-6 text-gray-400 space-y-4 opacity-70">
                                <div className="w-16 h-16 rounded-full bg-forest-800/50 flex items-center justify-center border border-white/5">
                                    <Icons.Bot className="w-8 h-8 text-accent-400" />
                                </div>
                                <p>How can I help you browse today?</p>
                            </div>
                        ) : (
                            messages.map(msg => (
                                <div key={msg.id} className={cn("flex w-full gap-3 animate-fade-in", msg.role === "user" ? "justify-end" : "justify-start")}>
                                    {msg.role === "assistant" && <div className="w-8 h-8 rounded-full bg-forest-800 flex items-center justify-center shrink-0 mt-1 border border-white/10"><Icons.Bot className="w-4 h-4 text-accent-400" /></div>}
                                    <div className={cn(
                                        "max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed",
                                        msg.role === "user" ? "bg-accent-600 text-white rounded-tr-sm shadow-lg" : "bg-forest-900/80 text-gray-100 rounded-tl-sm border border-white/10 shadow-sm"
                                    )}>
                                        {msg.content}
                                    </div>
                                    {msg.role === "user" && <div className="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center shrink-0 mt-1 shadow-lg"><Icons.User className="w-4 h-4 text-white" /></div>}
                                </div>
                            ))
                        )}
                        {isLoading && (
                            <div className="flex w-full gap-3 justify-start animate-fade-in">
                                <div className="w-8 h-8 rounded-full bg-forest-800 flex items-center justify-center shrink-0 mt-1 border border-white/10"><Icons.Bot className="w-4 h-4 text-accent-400" /></div>
                                <div className="bg-forest-900/80 text-gray-100 p-3 rounded-2xl rounded-tl-sm border border-white/10 flex items-center gap-2">
                                    <Icons.Loader2 className="w-3 h-3 animate-spin" /> Thinking...
                                </div>
                            </div>
                        )}
                        <div ref={endRef} />
                    </div>

                    <form onSubmit={handleSend} className="p-4 bg-forest-900/50 border-t border-white/10 rounded-b-2xl">
                        <div className="relative flex items-center">
                            <input 
                                type="text" 
                                value={input} 
                                onChange={e => setInput(e.target.value)}
                                placeholder="Ask anything..."
                                className="w-full bg-forest-950 border border-white/10 rounded-full py-3 pl-4 pr-12 text-sm text-white placeholder:text-gray-500 focus:outline-none focus:border-accent-500/50 focus:ring-1 focus:ring-accent-500/20 transition-all"
                            />
                            <button type="submit" disabled={!input.trim() || isLoading} 
                                className="absolute right-1.5 p-2 rounded-full bg-accent-600 text-white hover:bg-accent-500 disabled:opacity-0 transition-all shadow-lg">
                                <Icons.Send className="w-4 h-4" />
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        // HomePage
        const HomePage = () => {
            const { navigate } = useBrowser();
            const [search, setSearch] = useState("");
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);

            const COMMON_SITES = [
                { title: "YouTube", url: "youtube.com", icon: "" },
                { title: "GitHub", url: "github.com", icon: "" },
                { title: "Reddit", url: "reddit.com", icon: "" },
                { title: "Wikipedia", url: "wikipedia.org", icon: "" }
            ];

            // Mock autocomplete
            useEffect(() => {
                if (search.length > 1) {
                    const MOCK_SUGGESTIONS = [
                        "how to build a browser", "react tutorial", "loom browser", 
                        "groq api documentation", "tailwind css cheat sheet", 
                        "javascript array methods", "nextjs 15 features"
                    ];
                    setSuggestions(MOCK_SUGGESTIONS.filter(s => s.includes(search.toLowerCase())).slice(0, 5));
                    setShowSuggestions(true);
                } else {
                    setShowSuggestions(false);
                }
            }, [search]);

            const handleSearch = (e) => {
                e.preventDefault();
                if (search.trim()) navigate(search);
            };

            // Real DuckDuckGo Autocomplete
            useEffect(() => {
                if (search.length > 1) {
                    // Use a debounce to prevent too many requests
                    const timer = setTimeout(() => {
                        jsonp(`https://duckduckgo.com/ac/?q=${encodeURIComponent(search)}`, 'callback', (data) => {
                            // DDG returns [{phrase: "..."}]
                            if (data && Array.isArray(data)) {
                                setSuggestions(data.map(item => item.phrase).slice(0, 6));
                                setShowSuggestions(true);
                            }
                        });
                    }, 200);
                    return () => clearTimeout(timer);
                } else {
                    setShowSuggestions(false);
                }
            }, [search]);

            return (
                <div className="flex flex-col items-center justify-center w-full min-h-full p-6 animate-fade-in">
                    <div className="w-full max-w-2xl flex flex-col items-center space-y-10 -mt-16">
                        <div className="flex flex-col items-center space-y-4">
                            <div className="relative w-24 h-24 rounded-3xl bg-gradient-to-br from-forest-500 to-forest-700 shadow-glow flex items-center justify-center transform hover:scale-105 transition-transform duration-300">
                                <Icons.Compass className="w-12 h-12 text-white" />
                                <div className="absolute inset-0 bg-white/20 rounded-3xl blur-xl -z-10" />
                            </div>
                            <h1 className="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-forest-600 to-forest-400 dark:from-forest-400 dark:to-forest-200">Loom</h1>
                        </div>

                        <div className="w-full relative z-10">
                            <form onSubmit={handleSearch} className="relative group">
                                <div className="absolute inset-0 bg-forest-200 dark:bg-forest-800/50 rounded-3xl blur-md group-hover:blur-lg transition-all opacity-50" />
                                <div className={cn(
                                    "relative flex items-center w-full h-14 bg-white dark:bg-forest-900/80 border border-forest-200 dark:border-forest-700 shadow-xl px-6 transition-all",
                                    showSuggestions && suggestions.length > 0 ? "rounded-t-3xl border-b-0" : "rounded-full"
                                )}>
                                    <Icons.Search className="w-5 h-5 text-gray-400 mr-3" />
                                    <input 
                                        type="text" 
                                        value={search} 
                                        onChange={e => setSearch(e.target.value)}
                                        placeholder="Search the web..." 
                                        className="flex-1 bg-transparent border-none outline-none text-lg placeholder:text-gray-400 text-forest-900 dark:text-white" 
                                        autoFocus 
                                    />
                                </div>
                            </form>
                            
                            {showSuggestions && suggestions.length > 0 && (
                                <div className="absolute w-full bg-white dark:bg-forest-900/80 border border-t-0 border-forest-200 dark:border-forest-700 rounded-b-3xl shadow-xl overflow-hidden backdrop-blur-md z-50">
                                    {suggestions.map((s, i) => (
                                        <button 
                                            key={i}
                                            onClick={() => navigate(s)}
                                            className="w-full px-6 py-3 text-left text-forest-800 dark:text-gray-200 hover:bg-forest-100 dark:hover:bg-white/10 flex items-center gap-3"
                                        >
                                            <Icons.Search className="w-4 h-4 text-gray-400" /> {s}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-4 gap-4 md:gap-8 w-full px-4">
                            {COMMON_SITES.map((link, i) => (
                                <button key={i} onClick={() => navigate(`https://www.google.com/search?q=${encodeURIComponent(link.title)}`)} className="flex flex-col items-center space-y-3 group">
                                    <div className="w-14 h-14 rounded-2xl bg-white dark:bg-forest-900/60 shadow-md flex items-center justify-center text-2xl group-hover:scale-110 group-hover:bg-forest-800 transition-all border border-transparent group-hover:border-accent-500/30">
                                        {link.icon}
                                    </div>
                                    <span className="text-xs font-medium text-gray-600 dark:text-gray-400 group-hover:text-accent-500">{link.title}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Custom Search Results Component
        const SearchResultView = ({ query }) => {
            const [results, setResults] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!query) return;
                setLoading(true);
                setError(null);
                
                // Fetch DuckDuckGo Instant Answers via JSONP
                jsonp(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&pretty=1`, 'callback', (data) => {
                    setLoading(false);
                    if (data) {
                        setResults(data);
                    } else {
                        setError("No results found.");
                    }
                });
            }, [query]);

            return (
                <div className="w-full h-full bg-forest-50 dark:bg-forest-950 overflow-y-auto p-6 md:p-12">
                    <div className="max-w-4xl mx-auto">
                        <div className="mb-8">
                            <h1 className="text-3xl font-bold mb-2">{query}</h1>
                            <div className="text-sm text-forest-500 flex items-center gap-2">
                                <Icons.Search className="w-4 h-4" /> Results from DuckDuckGo
                            </div>
                        </div>

                        {loading ? (
                            <div className="space-y-8">
                                {[1, 2, 3].map(i => (
                                    <div key={i} className="animate-pulse">
                                        <div className="h-5 bg-forest-200 dark:bg-forest-800 rounded w-1/3 mb-2"></div>
                                        <div className="h-4 bg-forest-100 dark:bg-forest-900 rounded w-full mb-1"></div>
                                        <div className="h-4 bg-forest-100 dark:bg-forest-900 rounded w-2/3"></div>
                                    </div>
                                ))}
                            </div>
                        ) : error ? (
                            <div className="text-red-500">{error}</div>
                        ) : (
                            <div className="space-y-8">
                                {/* Abstract / Instant Answer */}
                                {results.AbstractText && (
                                    <div className="bg-white dark:bg-forest-900/50 border border-forest-200 dark:border-forest-800 rounded-xl p-6 shadow-sm">
                                        <h2 className="text-xl font-semibold mb-2">{results.Heading}</h2>
                                        <p className="text-forest-700 dark:text-forest-300 leading-relaxed">{results.AbstractText}</p>
                                        {results.AbstractURL && (
                                            <a href={results.AbstractURL} target="_blank" className="inline-flex items-center gap-1 text-accent-600 mt-3 text-sm hover:underline">
                                                Read more <Icons.ExternalLink className="w-3 h-3" />
                                            </a>
                                        )}
                                    </div>
                                )}

                                {/* Related Topics */}
                                {results.RelatedTopics && results.RelatedTopics.length > 0 && (
                                    <div className="space-y-4">
                                        {results.RelatedTopics.map((topic, i) => {
                                            if (!topic.FirstURL) return null; // Skip categories for now
                                            return (
                                                <div key={i} className="group">
                                                    <a href={topic.FirstURL} className="block text-lg font-medium text-accent-600 hover:underline mb-1">
                                                        {topic.Text.split(' - ')[0]}
                                                    </a>
                                                    <div className="text-green-800 dark:text-green-400 text-xs mb-1">{topic.FirstURL}</div>
                                                    <p className="text-sm text-forest-600 dark:text-forest-400">
                                                        {topic.Text.split(' - ')[1] || topic.Text}
                                                    </p>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {/* Fallback / External Links */}
                                <div className="pt-8 border-t border-forest-200 dark:border-forest-800">
                                    <h3 className="text-sm font-semibold text-forest-500 mb-4 uppercase tracking-wider">More Results</h3>
                                    <div className="flex gap-4 flex-wrap">
                                        <a href={`https://duckduckgo.com/?q=${encodeURIComponent(query)}`} target="_blank" 
                                            className="px-4 py-2 bg-forest-100 dark:bg-forest-900 rounded-lg hover:bg-forest-200 dark:hover:bg-forest-800 transition-colors text-sm flex items-center gap-2">
                                            View on DuckDuckGo <Icons.ExternalLink className="w-3 h-3" />
                                        </a>
                                        <a href={`https://www.google.com/search?q=${encodeURIComponent(query)}`} target="_blank"
                                            className="px-4 py-2 bg-forest-100 dark:bg-forest-900 rounded-lg hover:bg-forest-200 dark:hover:bg-forest-800 transition-colors text-sm flex items-center gap-2">
                                            View on Google <Icons.ExternalLink className="w-3 h-3" />
                                        </a>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Browser View
        const BrowserView = () => {
            const { activeTab } = useBrowser();
            const { searchEngine } = useSettings();
            const [iframeError, setIframeError] = useState(false);
            
            // Force re-render on refresh
            const [refreshKey, setRefreshKey] = useState(0);

            useEffect(() => {
                setIframeError(false);
                setRefreshKey(Date.now());
            }, [activeTab?.url, activeTab?.query, activeTab?.timestamp]);

            if (!activeTab) return null;
            if (activeTab.type === "home") return <HomePage />;
            if (activeTab.type === "search") return <SearchResultView query={activeTab.query} />;

            // Site View
            return (
                <div className="w-full h-full relative bg-white dark:bg-forest-950 overflow-hidden">
                    {iframeError ? (
                        <div className="flex flex-col items-center justify-center h-full p-8 text-center animate-fade-in">
                            <div className="w-20 h-20 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mb-6">
                                <Icons.Globe className="w-10 h-10 text-red-500" />
                            </div>
                            <h2 className="text-2xl font-bold mb-2">Connection Prevented</h2>
                            <p className="text-forest-500 max-w-md mb-6">
                                <strong>{new URL(activeTab.url).hostname}</strong> blocks access from inside other browsers.
                            </p>
                            <a href={activeTab.url} target="_blank" className="px-6 py-2 bg-accent-600 hover:bg-accent-500 text-white rounded-lg font-medium shadow-lg transition-transform hover:scale-105 flex items-center gap-2">
                                Open in New Tab <Icons.ExternalLink className="w-4 h-4" />
                            </a>
                        </div>
                    ) : (
                        <div className="w-full h-full relative">
                            <iframe 
                                key={refreshKey}
                                src={activeTab.url} 
                                className="w-full h-full border-none bg-white"
                                onError={() => setIframeError(true)}
                                title="Browser View"
                                sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                            />
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            return (
                <SettingsProvider>
                    <BrowserProvider>
                        <AIProvider>
                            <div className="flex flex-col h-screen w-full overflow-hidden">
                                <BrowserChrome />
                                <div className="flex-1 relative overflow-hidden">
                                    <BrowserView />
                                    <AIAssistant />
                                </div>
                            </div>
                        </AIProvider>
                    </BrowserProvider>
                </SettingsProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>